
/**
 * @file Firestore Security Rules for Finwise Compass
 * @description This ruleset enforces a strict user-ownership model for user data, and allows public read access for blog content.
 *
 * Data Structure:
 * - User-specific data is nested under /users/{userId}.
 * - Public blog posts are stored in the /blogPosts collection.
 *
 * Key Security Decisions:
 * - No public listing of any user-specific collections.
 * - All write operations on user data require a verified user identity (request.auth != null).
 * - Blog posts are publicly readable but writable only by authenticated users (future: admins).
 * - The /mail collection is write-only for authenticated users to trigger emails.
 *
 * Denormalization for Authorization:
 * The userId is implicitly denormalized by being part of the path for all user-owned data. This enables simpler, more performant security rules by avoiding the need for additional `get()` calls to check ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /******************** USERS ********************/

    /**
     * @description Manages user profiles. Only the authenticated user can read/write their own profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /******************** USER SUBCOLLECTIONS ********************/

    /**
     * @description Manages financial goals for each user. Only the authenticated user can manage their own goals.
     */
    match /users/{userId}/financialGoals/{financialGoalId} {
      allow get, update, delete: if isOwner(userId);
      allow list, create: if isOwner(userId);
    }

    /**
     * @description Manages budgets for each user. Only the authenticated user can manage their own budgets.
     */
    match /users/{userId}/budgets/{budgetId} {
      allow get, update, delete: if isOwner(userId);
      allow list, create: if isOwner(userId);
    }

    /**
     * @description Manages expenses for each budget. Only the authenticated user can manage their own expenses.
     */
    match /users/{userId}/budgets/{budgetId}/expenses/{expenseId} {
      allow get, update, delete: if isOwner(userId);
      allow list, create: if isOwner(userId);
    }

    /**
     * @description Manages investments for each user. Only the authenticated user can manage their own investments.
     */
    match /users/{userId}/investments/{investmentId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages chat messages for each user. Only the authenticated user can manage their own chat messages.
     */
    match /users/{userId}/chatMessages/{chatMessageId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
    
    /**
     * @description Manages business profiles for each user. Only the authenticated user can manage their own business profile.
     */
    match /users/{userId}/businesses/{businessId} {
      allow get, create, update, delete: if isOwner(userId);
      allow list: if isOwner(userId);
    }

    /**
     * @description Manages financial transactions for each business. Only the owner of the business can manage its transactions.
     */
    match /users/{userId}/businesses/{businessId}/transactions/{transactionId} {
      allow get, create, update, delete: if isOwner(userId);
      allow list: if isOwner(userId);
    }

    /******************** BLOG ********************/
    
    /**
     * @description Manages blog posts. Allows public read access to everyone, but write access only to authenticated users.
     * In a production app, 'create', 'update', 'delete' would be restricted to admin roles.
     */
    match /blogPosts/{postId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn(); // Simplified for now. Should be admin-only.
    }
    
    /******************** MAIL ********************/

    /**
     * @description Collection used by the "Trigger Email" extension.
     * Allows any authenticated user to create (i.e., queue an email for sending).
     * Disallows read, update, and delete to protect user privacy and prevent tampering.
     */
    match /mail/{mailId} {
      allow get, list, update, delete: if false;
      allow create: if isSignedIn();
    }
  }
}

    